## Khó khăn khi làm dynamic intake form

1- Đồng bộ schema động với BE: cấu trúc, validation, default values, điều kiện hiển thị thay đổi theo thời gian → cần sinh schema và UI runtime thay vì hard-code. Tham chiếu: generateIntakeFormSchema[](src/schema-validations/IntakeForm.schema.ts), kiểu dữ liệu [](http://_vscodecontentref_/0)IIntakeFormStructure.
2- Điều kiện hiển thị/ẩn và prefill theo câu trả lời bệnh nhân → phải tính toán xuyên field/section, giữ state ổn định theo tab. Tham chiếu: hook trung tâm [useIntakeFormHook[](src/app/[locale]/intake-form/main-intake-form/useIntakeForm.tsx) với ](http://_vscodecontentref_/1)isFieldVisible, validateNextStep, handleEnterPress.
3- Tối ưu hiệu năng khi form lớn (nhiều section/field) → tránh re-render thừa, chia nhỏ UI theo section/field. Tham chiếu: UI tách lớp IntakeFormUI[](src/app/[locale]/intake-form/main-intake-form/IntakeFormUI.tsx), [](http://_vscodecontentref_/2)RenderSection[](src/app/[locale]/intake-form/main-intake-form/RenderSection.tsx), [](http://_vscodecontentref_/3)RenderField[](src/app/[locale]/intake-form/main-intake-form/RenderField.tsx), [](http://_vscodecontentref_/4)MemoizedFieldRender.
4- Luồng xác thực token một lần, upload file theo presigned URL và submit dữ liệu một cách “atomic” → thứ tự bước, xử lý lỗi và trạng thái hết hạn. Tham chiếu: container BodyIntakeForm[](src/app/[locale]/intake-form/main-intake-form/BodyIntakeForm.tsx), service [](http://_vscodecontentref_/5)verifyActionToken[](src/services/intakeForm.service.ts), [](http://_vscodecontentref_/6)getSubmissionPresignedUrl[](src/services/intakeForm.service.ts), [](http://_vscodecontentref_/7)submitCollectForm[](src/services/intakeForm.service.ts), helper chuyển đổi dữ liệu [](http://_vscodecontentref_/8)convertIntakeDataToSubmit.
5- i18n và điều hướng theo bước (stepper) động → đồng bộ label/tab/tải trước bước kế tiếp. Tham chiếu: constants TAB*LABELS, TAB_SECTION_MAP[](src/lib/constants/intakeForm.constants.ts), header/tab/sidebar/footer: [](http://\_vscodecontentref*/9)HeaderIntakeForm[](src/app/[locale]/intake-form/components/HeaderIntakeForm.tsx), [](http://_vscodecontentref_/10)IntakeFormTab[](src/app/[locale]/intake-form/components/IntakeFormTab.tsx), [](http://_vscodecontentref_/11)SidebarIntakeForm[](src/app/[locale]/intake-form/components/SidebarIntakeForm.tsx), [](http://_vscodecontentref_/12)FooterIntakeForm.
6- Trạng thái lỗi/hết hạn/thiết bị nhỏ → trải nghiệm người dùng và bảo mật link dùng 1 lần. Tham chiếu: constants INTAKE*FORM_ERROR_STATUS[](src/lib/constants/intakeForm.constants.ts), trang lỗi [](http://\_vscodecontentref*/13)FormExpired[](src/app/[locale]/intake-form/components/FormExpired.tsx), trang thành công [](http://_vscodecontentref_/14)PageSuccessMessage.

## Cách giải quyết

1- Sinh schema động và default values từ cấu hình BE để RHF + Zod validate runtime: generateIntakeFormSchema[](src/schema-validations/IntakeForm.schema.ts) + hook [](http://_vscodecontentref_/15)useIntakeFormHook.
2- Quản lý bước/tab + state toàn cục bằng Zustand để điều hướng mượt: store useIntakeForm[](src/stores/useIntakeForm.store.ts), UI điều hướng [](http://_vscodecontentref_/16)IntakeFormUI[](src/app/[locale]/intake-form/main-intake-form/IntakeFormUI.tsx), footer gọi ](http://_vscodecontentref_/17)validateNextStep[ trước khi chuyển bước [](http://_vscodecontentref_/18)FooterIntakeForm.
3- Tối ưu re-render: tách Section/Field, memo hóa UI [MemoizedFieldRender[](src/app/[locale]/intake-form/main-intake-form/MemoizedFieldRender.tsx), chỉ re-render theo ](http://_vscodecontentref_/19)currentTab. Layout tự suy luận theo type để giữ lưới ổn định: inferLayoutFromType, LAYOUT*PATTERNS, MAX_FIELDS_PER_ROW.
4- Submit “an toàn”: xác thực token → xin presigned URL → upload S3 → map dữ liệu → submit → hiển thị kết quả. Toàn bộ orchestration ở [BodyIntakeForm[](src/app/[locale]/intake-form/main-intake-form/BodyIntakeForm.tsx) với dịch vụ [](http://\_vscodecontentref*/20)verifyActionToken[](src/services/intakeForm.service.ts), [](http://_vscodecontentref_/21)getSubmissionPresignedUrl[](src/services/intakeForm.service.ts), [](http://_vscodecontentref_/22)submitCollectForm[](src/services/intakeForm.service.ts) và helper [](http://_vscodecontentref_/23)convertIntakeDataToSubmit[](src/lib/helper/intakeForm.helper.ts). Xử lý lỗi theo mã về trạng thái UI: ](http://_vscodecontentref_/24)mapErrorCodeToStatus trong BodyIntakeForm.
5- i18n/UX: lấy label từ khóa i18n do BE trả về, render tiêu đề theo tab hiện tại: HeaderIntakeForm.

## Nếu làm lại, tối ưu gì và như thế nào

1- Type-safety mạnh hơn cho dữ liệu động: sinh TypeScript types từ JSON Schema của BE và dùng z.infer để type cho RHF, giảm any. Tập trung ở useIntakeFormHook[](src/app/[locale]/intake-form/main-intake-form/useIntakeForm.tsx) và [](http://_vscodecontentref_/29)generateIntakeFormSchema.
2- Hiệu năng form lớn: - Virtualize danh sách field theo section để giảm DOM (react-window/react-virtualized) tại RenderSection. - Debounce/threshold validation theo field thay vì onChange toàn form trong useIntakeFormHook. - Tiền biên dịch schema/điều kiện hiển thị và cache theo version cấu hình.
3- Upload tệp: giới hạn song song (concurrency 3–5), retry/backoff, progress UI; có thể chunked upload nếu BE hỗ trợ. Tối ưu flow ở BodyIntakeForm[](src/app/[locale]/intake-form/main-intake-form/BodyIntakeForm.tsx) và dịch vụ [](http://_vscodecontentref_/32)getSubmissionPresignedUrl.
4- Trải nghiệm và khả dụng: - Auto-save bản nháp theo section; resume sau khi gián đoạn trong BodyIntakeForm. - Hỗ trợ mobile (hiện đang chặn thiết bị nhỏ) bằng layout rút gọn/one-column và lược bớt hình ảnh, xem xét NO_SUPPORT_SMALL_SCREEN ở INTAKE_FORM_ERROR_STATUS. - Accessibility: focus management khi có lỗi, aria-describedby cho message tại RenderField.
5- Quan sát và test: - Contract test cho cấu hình BE, unit test cho mapping convertIntakeDataToSubmit và điều kiện hiển thị. - Logging/telemetry khi cấu hình không hợp lệ để phản hồi BE sớm. - Storybook “dynamic” dùng mock cấu hình để QA nhanh nhiều biến thể.
